#include <stdio.h>
#include <pthread.h>
#include <semaphore.h>
#include <unistd.h>

#define N 5   // Number of philosophers

sem_t chopstick[N];
sem_t room;   // Limits philosophers to N-1

void* philosopher(void* num)
{
    int id = *(int*)num;

    while(1)
    {
        printf("Philosopher %d is thinking\n", id);
        sleep(1);

        // Enter room
        sem_wait(&room);

        // Pick chopsticks
        sem_wait(&chopstick[id]);
        sem_wait(&chopstick[(id+1)%N]);

        printf("Philosopher %d is eating\n", id);
        sleep(2);

        // Put chopsticks back
        sem_post(&chopstick[id]);
        sem_post(&chopstick[(id+1)%N]);

        // Leave room
        sem_post(&room);

        printf("Philosopher %d finished eating\n", id);
    }
}

int main()
{
    pthread_t p[N];
    int id[N];
    int i;

    // Initialize room semaphore (N-1 philosophers allowed)
    sem_init(&room,0,N-1);

    // Initialize chopsticks
    for(i=0;i<N;i++)
        sem_init(&chopstick[i],0,1);

    // Create philosophers
    for(i=0;i<N;i++)
    {
        id[i]=i;
        pthread_create(&p[i],NULL,philosopher,&id[i]);
    }

    // Join threads
    for(i=0;i<N;i++)
        pthread_join(p[i],NULL);

    return 0;
}